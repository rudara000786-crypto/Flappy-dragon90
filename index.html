<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dragon Flight - Lair Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #1a0a1a; font-family: 'Arial Black', sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; }
        canvas { display: block; margin: 0 auto; touch-action: none; background: linear-gradient(to bottom, #1a0a1a, #4a0404); }
        #ui-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; pointer-events: none; z-index: 10; }
        .btn { pointer-events: auto; cursor: pointer; transition: transform 0.1s; z-index: 20; }
        .btn:active { transform: scale(0.95); }
        #ability-tag { position: absolute; top: 120px; font-size: 1.2rem; font-weight: 900; color: #fff; text-shadow: 2px 2px #000; text-transform: uppercase; background: rgba(255,69,0,0.3); padding: 6px 16px; border-radius: 30px; opacity: 0; transition: opacity 0.3s; border: 2px solid #ff4500; }
        #boss-warning { color: #ff0000; font-weight: 900; font-size: 3rem; text-shadow: 4px 4px #000; animation: blink 0.15s infinite; text-transform: uppercase; display: none; }
        @keyframes blink { 0%, 100% { opacity: 1; transform: scale(1.1); } 50% { opacity: 0.5; transform: scale(1); } }
    </style>
</head>
<body>

    <div id="ui-overlay">
        <div id="start-screen" class="text-center">
            <h1 class="text-5xl font-bold text-white drop-shadow-lg mb-2" style="-webkit-text-stroke: 1.5px #ff4500;">DRAGON LAIR</h1>
            <div class="mb-8">
                <p class="text-gray-300 text-xs font-bold tracking-widest mb-1">Created by</p>
                <h2 class="text-red-500 text-3xl font-black drop-shadow-md"> LS PRODUCTION </h2>
            </div>
            <button id="start-btn" class="btn bg-red-700 hover:bg-red-800 text-white font-bold py-4 px-10 rounded-lg border-b-4 border-black text-2xl">ENTER LAIR</button>
        </div>

        <div id="game-over-screen" class="hidden text-center bg-black/80 p-8 rounded-2xl shadow-2xl border-4 border-orange-600">
            <h2 class="text-4xl font-bold text-red-500 mb-2">LAIR CLAIMED</h2>
            <p id="final-score" class="text-3xl font-bold text-white mb-1">Score: 0</p>
            <p id="high-score" class="text-xl font-bold text-orange-400 mb-6">Best: 0</p>
            <button id="restart-btn" class="btn bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-8 rounded-lg border-b-4 border-orange-900 text-xl">TRY AGAIN</button>
        </div>

        <div id="boss-warning">ANCIENT GUARDIAN AWAKENS!</div>
        <div id="ability-tag">GHOST MODE</div>
        <div id="score-display" class="hidden absolute top-12 text-6xl font-black text-white drop-shadow-lg" style="-webkit-text-stroke: 2px #000;">0</div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // --- Audio Logic ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let musicStarted = false;

        function playJumpSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sawtooth'; 
            osc.frequency.setValueAtTime(120, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(30, audioCtx.currentTime + 0.15);
            gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.15);
        }

        function startMusic() {
            if (musicStarted) return;
            musicStarted = true;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const playNote = (freq, startTime, duration) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                const filter = audioCtx.createBiquadFilter();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(freq, startTime);
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(400, startTime);
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(0.04, startTime + 0.5);
                gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
                osc.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination);
                osc.start(startTime); osc.stop(startTime + duration);
            };

            const sequence = () => {
                const now = audioCtx.currentTime;
                playNote(38.89, now, 4); // Ominous Bass Notes
                playNote(30.87, now + 4, 4);
                playNote(29.14, now + 8, 4);
                setTimeout(sequence, 12000);
            };
            sequence();
        }

        const GRAVITY = 0.22;
        const JUMP_STRENGTH = -4.8;
        let pipeSpeed = 2.4;
        const PIPE_GAP = 180; 
        const BIRD_SIZE_W = 46; 
        const BIRD_SIZE_H = 34;

        let gameState = 'START'; 
        let score = 0;
        let highScore = localStorage.getItem('lairHighScore') || 0;
        let frameCount = 0;

        let bird = { x: 0, y: 0, velocity: 0, width: BIRD_SIZE_W, height: BIRD_SIZE_H, rotation: 0 };
        let activeAbility = null;
        let abilityTimer = 0;
        let abilityItems = []; 
        let nextAbilityScore = 15;

        const BOSS_MILESTONES = [20, 50, 100, 150, 200];
        let bossActive = false;
        let bossTriggeredScores = new Set();
        let boss = { x: 0, y: 0, width: BIRD_SIZE_W * 1.8, height: BIRD_SIZE_H * 1.8, timer: 0, state: 'FOLLOW', dashCooldown: 120, homeX: 0, rotation: 0 };

        let pipes = [];
        let skyline = [];
        let fireParticles = [];

        function resize() {
            canvas.width = Math.min(window.innerWidth, 480);
            canvas.height = window.innerHeight;
            bird.x = canvas.width / 4;
            bird.y = canvas.height / 2;
            initBackground();
        }

        function initBackground() {
            fireParticles = [];
            for(let i=0; i<20; i++) fireParticles.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, s: 1 + Math.random() * 3, speed: 0.5 + Math.random() * 1 });
            skyline = [];
            for(let i=0; i<15; i++) skyline.push({ x: i*40, h: 50 + Math.random() * 150, w: 41, color: i%2===0 ? '#2a1a2a' : '#1a0a1a' });
        }

        window.addEventListener('resize', resize);
        resize();

        function spawnPipe() {
            if (bossActive || BOSS_MILESTONES.includes(score + 1)) return;
            const minH = 100;
            const maxH = canvas.height - PIPE_GAP - minH - 120;
            const top = Math.floor(Math.random() * (maxH - minH + 1)) + minH;
            pipes.push({ x: canvas.width, top, passed: false });

            if (score >= nextAbilityScore) {
                const types = ['GHOST MODE', 'SHRINK', 'SLOW MO', 'SHIELD', 'WIDE GAP'];
                const colors = ['#ffffff', '#00ffff', '#ffff00', '#00ff00', '#ff8800'];
                const idx = Math.floor(Math.random() * types.length);
                abilityItems.push({ x: canvas.width + 120, y: top + PIPE_GAP / 2, type: types[idx], color: colors[idx], w: 28, h: 28, rotation: 0 });
                nextAbilityScore = score + 20 + Math.floor(Math.random() * 15);
            }
        }

        function drawBird(x, y, w, h, rot, isBoss = false) {
            ctx.save(); ctx.translate(x + w / 2, y + h / 2); ctx.rotate(rot);
            if (isBoss) ctx.scale(-1, 1); 
            ctx.lineWidth = 2; ctx.strokeStyle = 'black';
            if (!isBoss && activeAbility === 'GHOST MODE') ctx.globalAlpha = 0.5;
            const bodyColor = isBoss ? '#4a0404' : (activeAbility === 'SHRINK' ? '#00FFFF' : (activeAbility === 'SHIELD' ? '#00FF00' : '#d63031'));
            ctx.fillStyle = '#1a1a1a';
            for(let i=0; i<3; i++) { ctx.beginPath(); ctx.moveTo(-w/2 + (i*w/4), -h/4); ctx.lineTo(-w/2 + (i*w/4) + 5, -h/1.1); ctx.lineTo(-w/2 + (i*w/4) + 10, -h/4); ctx.fill(); }
            ctx.fillStyle = bodyColor;
            ctx.beginPath(); ctx.ellipse(0, 0, w/1.8, h/2.2, 0, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
            const flap = Math.sin(frameCount * 0.3) * (h/2);
            ctx.fillStyle = isBoss ? '#2a0202' : '#8e1a1a';
            ctx.beginPath(); ctx.moveTo(-w/4, 0); ctx.lineTo(-w/1.1, -h/1.2 + flap); ctx.lineTo(-w/3, -h/4); ctx.fill(); ctx.stroke();
            ctx.fillStyle = bodyColor;
            ctx.beginPath(); ctx.ellipse(w/2.5, -h/4, w/3.2, h/3.2, 0.4, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
            ctx.fillStyle = '#f1c40f'; ctx.beginPath(); ctx.arc(w/2.2, -h/3.2, h/7, 0, Math.PI * 2); ctx.fill();
            if (activeAbility === 'SHIELD' && !isBoss) { ctx.strokeStyle = '#00ff00'; ctx.lineWidth = 4; ctx.beginPath(); ctx.arc(0, 0, w*0.9, 0, Math.PI*2); ctx.stroke(); }
            ctx.restore();
        }

        function update() {
            if (gameState !== 'PLAYING') return;
            frameCount++;
            fireParticles.forEach(p => { p.y -= p.speed; if(p.y < 0) p.y = canvas.height; });
            if (activeAbility) { abilityTimer--; if (abilityTimer <= 0) { pipeSpeed = 2.4; activeAbility = null; bird.width = BIRD_SIZE_W; bird.height = BIRD_SIZE_H; document.getElementById('ability-tag').style.opacity = 0; } }
            bird.velocity += GRAVITY; bird.y += bird.velocity;
            bird.rotation = Math.min(Math.PI/2, Math.max(-Math.PI/6, bird.velocity * 0.12));

            if (BOSS_MILESTONES.includes(score) && !bossActive && !bossTriggeredScores.has(score)) {
                bossActive = true; bossTriggeredScores.add(score); pipes = []; boss.x = canvas.width + 150; boss.y = canvas.height / 2; boss.homeX = canvas.width - (boss.width + 50); boss.timer = 0; boss.state = 'FOLLOW'; boss.dashCooldown = 120;
                document.getElementById('boss-warning').style.display = 'block'; setTimeout(() => document.getElementById('boss-warning').style.display = 'none', 1500);
            }

            if (bossActive) {
                boss.timer++; boss.rotation = Math.sin(frameCount * 0.1) * 0.2;
                if (boss.state === 'FOLLOW') { if (boss.x > boss.homeX) boss.x -= 2; boss.y += (bird.y - (boss.y + boss.height/2) + bird.height/2) * 0.045; boss.dashCooldown--; if (boss.dashCooldown <= 0) { boss.state = 'CHARGE'; boss.dashCooldown = 60; } }
                else if (boss.state === 'CHARGE') { boss.dashCooldown--; boss.y += (Math.random() - 0.5) * 8; if (boss.dashCooldown <= 0) boss.state = 'DASH'; }
                else if (boss.state === 'DASH') { boss.x -= 20; if (boss.x < -boss.width - 100) { boss.state = 'RECOVER'; boss.x = -boss.width - 50; } }
                else if (boss.state === 'RECOVER') { if (boss.x < boss.homeX) boss.x += 12; else { boss.x = boss.homeX; boss.state = 'FOLLOW'; boss.dashCooldown = 140; } }
                const dx = (bird.x + bird.width/2) - (boss.x + boss.width/2);
                const dy = (bird.y + bird.height/2) - (boss.y + boss.height/2);
                if (Math.sqrt(dx*dx + dy*dy) < (boss.width/2 + bird.width/2 - 10) && activeAbility !== 'GHOST MODE') {
                    if (activeAbility === 'SHIELD') { activeAbility = null; bird.width = BIRD_SIZE_W; bird.height = BIRD_SIZE_H; document.getElementById('ability-tag').style.opacity = 0; } else endGame();
                }
                if (boss.timer >= 1200) { bossActive = false; score++; document.getElementById('score-display').innerText = score; }
            } else {
                if (pipes.length === 0 || pipes[pipes.length - 1].x < canvas.width - 240) spawnPipe();
                for (let i = pipes.length - 1; i >= 0; i--) {
                    let p = pipes[i]; p.x -= pipeSpeed;
                    const pw = 60; const gapHeight = activeAbility === 'WIDE GAP' ? PIPE_GAP + 60 : PIPE_GAP;
                    if (activeAbility !== 'GHOST MODE' && bird.x + bird.width*0.7 > p.x && bird.x + bird.width*0.2 < p.x + pw) {
                        if (bird.y + bird.height*0.2 < p.top || bird.y + bird.height*0.8 > p.top + gapHeight) {
                            if (activeAbility === 'SHIELD') { activeAbility = null; document.getElementById('ability-tag').style.opacity = 0; } else endGame();
                        }
                    }
                    if (!p.passed && bird.x > p.x + pw) { p.passed = true; score++; document.getElementById('score-display').innerText = score; }
                    if (p.x < -100) pipes.splice(i, 1);
                }
            }
            for (let i = abilityItems.length - 1; i >= 0; i--) {
                let s = abilityItems[i]; s.x -= pipeSpeed;
                if (Math.abs(bird.x - s.x) < 40 && Math.abs(bird.y - s.y) < 40) {
                    activeAbility = s.type; abilityTimer = 500;
                    if (activeAbility === 'SHRINK') { bird.width = BIRD_SIZE_W/2; bird.height = BIRD_SIZE_H/2; }
                    else if (activeAbility === 'SLOW MO') pipeSpeed = 1.4;
                    document.getElementById('ability-tag').innerText = activeAbility; document.getElementById('ability-tag').style.opacity = 1;
                    abilityItems.splice(i, 1);
                } else if (s.x < -50) abilityItems.splice(i, 1);
            }
            if (bird.y + bird.height > canvas.height - 80 || bird.y < -50) endGame();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'rgba(255, 69, 0, 0.4)';
            fireParticles.forEach(p => ctx.fillRect(p.x, p.y, p.s, p.s));
            skyline.forEach(s => { ctx.fillStyle = s.color; ctx.fillRect(s.x, canvas.height - 80 - s.h, s.w, s.h); });

            pipes.forEach(p => {
                const pw = 60; const gapH = activeAbility === 'WIDE GAP' ? PIPE_GAP + 60 : PIPE_GAP;
                const grad = ctx.createLinearGradient(p.x, 0, p.x + pw, 0);
                grad.addColorStop(0, '#1a1a1a'); grad.addColorStop(0.5, '#ff4500'); grad.addColorStop(1, '#1a1a1a');
                ctx.fillStyle = grad;
                ctx.beginPath(); ctx.moveTo(p.x, 0); ctx.lineTo(p.x + pw/2, p.top); ctx.lineTo(p.x + pw, 0); ctx.fill();
                ctx.beginPath(); ctx.moveTo(p.x, canvas.height - 80); ctx.lineTo(p.x + pw/2, p.top + gapH); ctx.lineTo(p.x + pw, canvas.height - 80); ctx.fill();
            });

            abilityItems.forEach(s => {
                ctx.save(); ctx.translate(s.x + s.w/2, s.y + s.h/2); s.rotation += 0.1; ctx.rotate(s.rotation); ctx.fillStyle = s.color; ctx.beginPath();
                for(let i=0; i<5; i++) { ctx.lineTo(Math.cos((18+i*72)/180*Math.PI)*18, -Math.sin((18+i*72)/180*Math.PI)*18); ctx.lineTo(Math.cos((54+i*72)/180*Math.PI)*9, -Math.sin((54+i*72)/180*Math.PI)*9); }
                ctx.closePath(); ctx.fill(); ctx.stroke(); ctx.restore();
            });

            if (bossActive) {
                drawBird(boss.x, boss.y, boss.width, boss.height, boss.rotation, true);
                ctx.fillStyle = 'rgba(0,0,0,0.6)'; ctx.fillRect(60, 45, canvas.width - 120, 15);
                ctx.fillStyle = '#ff0000'; ctx.fillRect(60, 45, (canvas.width - 120) * (1 - boss.timer/1200), 15);
            }

            ctx.fillStyle = '#1a0a0a'; ctx.fillRect(0, canvas.height - 80, canvas.width, 80);
            ctx.fillStyle = '#ff4500'; ctx.fillRect(0, canvas.height - 80, canvas.width, 8);
            drawBird(bird.x, bird.y, bird.width, bird.height, bird.rotation);
        }

        function endGame() {
            if (gameState === 'GAMEOVER') return;
            gameState = 'GAMEOVER';
            if (score > highScore) { highScore = score; localStorage.setItem('lairHighScore', highScore); }
            document.getElementById('final-score').innerText = `Score: ${score}`;
            document.getElementById('high-score').innerText = `Best: ${highScore}`;
            document.getElementById('game-over-screen').classList.remove('hidden');
            document.getElementById('score-display').classList.add('hidden');
        }

        function startGame() {
            startMusic();
            score = 0; pipes = []; abilityItems = []; activeAbility = null; frameCount = 0;
            bossActive = false; bossTriggeredScores.clear(); bird.width = BIRD_SIZE_W; bird.height = BIRD_SIZE_H;
            bird.y = canvas.height / 2; bird.velocity = 0; bird.rotation = 0; pipeSpeed = 2.4;
            gameState = 'PLAYING';
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-over-screen').classList.add('hidden');
            document.getElementById('score-display').classList.remove('hidden');
            document.getElementById('score-display').innerText = '0';
        }

        window.addEventListener('mousedown', () => { if (gameState === 'PLAYING') { bird.velocity = JUMP_STRENGTH; playJumpSound(); } });
        window.addEventListener('touchstart', (e) => { if (gameState === 'PLAYING') { e.preventDefault(); bird.velocity = JUMP_STRENGTH; playJumpSound(); } }, {passive: false});
        document.getElementById('start-btn').addEventListener('click', (e) => { e.stopPropagation(); startGame(); });
        document.getElementById('restart-btn').addEventListener('click', (e) => { e.stopPropagation(); startGame(); });

        function loop() { update(); draw(); requestAnimationFrame(loop); }
        loop();
    </script>
</body>
</html>